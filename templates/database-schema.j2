# Database Schema Template

## Purpose
Generate database schemas with migrations and documentation.

## Template Variables
- {{database_type}}: PostgreSQL, MySQL, MongoDB, etc.
- {{schema_name}}: Schema/database name
- {{tables}}: List of tables
- {{indexes}}: List of indexes
- {{views}}: List of views

## Generated Output

\`\`\`sql
-- ========================================
-- {{schema_name}} Schema
-- Generated by Awesome-Grok-Workflows
-- Database: {{database_type}}
-- ========================================

-- Create extension for UUID generation
{% if database_type == 'PostgreSQL' %}
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
{% endif %}

-- ========================================
-- Enum Types
-- ========================================
{% for enum in enums %}
CREATE TYPE {{enum.name}} AS ENUM (
{% for value in enum.values %}
    '{{value}}'{% if not loop.last %},{% endif %}
{% endfor %}
);
{% endfor %}

-- ========================================
-- Tables
-- ========================================
{% for table in tables %}
-- Table: {{table.name}}
-- Description: {{table.description}}
CREATE TABLE {% if table.schema %}{{table.schema}}.{% endif %}{{table.name}} (
{% for column in table.columns %}
    {{column.name}} {{column.type}}{% if column.constraints %}{{column.constraints}}{% endif %}{% if not loop.last %},{% endif %}
{% endfor %}
{% if table.primary_key %}
    ,PRIMARY KEY ({{table.primary_key}})
{% endif %}
{% if table.foreign_keys %}
{% for fk in table.foreign_keys %}
    ,FOREIGN KEY ({{fk.column}}) REFERENCES {{fk.references}}({{fk.references_column}})
{% endfor %}
{% endif %}
);

-- Add comments
COMMENT ON TABLE {% if table.schema %}{{table.schema}}.{% endif %}{{table.name}} IS '{{table.description}}';
{% for column in table.columns %}
COMMENT ON COLUMN {% if table.schema %}{{table.schema}}.{% endif %}{{table.name}}.{{column.name}} IS '{{column.description}}';
{% endfor %}

{% endfor %}

-- ========================================
-- Indexes
-- ========================================
{% for index in indexes %}
CREATE{% if index.unique %} UNIQUE{% endif %} INDEX {{index.name}}
ON {% if index.schema %}{{index.schema}}.{% endif %}{{index.table}}
{% if index.method %}({{index.method}} {% endif %}({{index.columns}}){% if index.where %}{% endif %});

{% endfor %}

-- ========================================
-- Views
-- ========================================
{% for view in views %}
CREATE OR REPLACE VIEW {% if view.schema %}{{view.schema}}.{% endif %}{{view.name}} AS
{{view.definition}};

COMMENT ON VIEW {% if view.schema %}{{view.schema}}.{% endif %}{{view.name}} IS '{{view.description}}';
{% endfor %}

-- ========================================
-- Triggers
-- ========================================
{% for trigger in triggers %}
CREATE OR REPLACE FUNCTION {{trigger.function_name}}()
RETURNS TRIGGER AS $$
BEGIN
    {{trigger.logic}}
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER {{trigger.name}}
    {{trigger.timing}} {{trigger.event}}
    ON {% if trigger.schema %}{{trigger.schema}}.{% endif %}{{trigger.table}}
    FOR EACH ROW
    EXECUTE FUNCTION {{trigger.function_name}}();
{% endfor %}

-- ========================================
-- Seed Data (Optional)
-- ========================================
{% for seed in seed_data %}
-- Inserting into {{seed.table}}
INSERT INTO {% if seed.schema %}{{seed.schema}}.{% endif %}{{seed.table}} ({{seed.columns|join(', ')}})
VALUES
{% for row in seed.values %}
    ({{row|join(', ')}}){% if not loop.last %},{% endif %}
{% endfor %};
{% endfor %}
\`\`\`

## Migration File Example

\`\`\`sql
-- Migration: add_user_subscription
-- Description: Add subscription fields to users table
-- Date: 2024-01-15
-- Direction: up

BEGIN;

-- Add subscription columns
ALTER TABLE users
    ADD COLUMN subscription_tier VARCHAR(50) DEFAULT 'free',
    ADD COLUMN subscription_status VARCHAR(20) DEFAULT 'active',
    ADD COLUMN subscription_expires_at TIMESTAMP WITH TIME ZONE,
    ADD COLUMN created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();

-- Create index for faster queries
CREATE INDEX idx_users_subscription ON users(subscription_status, subscription_tier);

-- Update existing users
UPDATE users
SET subscription_tier = 'premium'
WHERE id IN (SELECT user_id FROM orders WHERE total_spent > 1000);

COMMIT;

-- Rollback
-- ALTER TABLE users
--     DROP COLUMN subscription_tier,
--     DROP COLUMN subscription_status,
--     DROP COLUMN subscription_expires_at,
--     DROP COLUMN created_at;
-- DROP INDEX IF EXISTS idx_users_subscription;
\`\`\`
